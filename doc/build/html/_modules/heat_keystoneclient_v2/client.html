<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>heat_keystoneclient_v2.client &mdash; heat 2015.1.dev542.ga481ba9 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2015.1.dev542.ga481ba9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="heat 2015.1.dev542.ga481ba9 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for heat_keystoneclient_v2.client</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c">#    a copy of the License at</span>
<span class="c">#</span>
<span class="c">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c">#    License for the specific language governing permissions and limitations</span>
<span class="c">#    under the License.</span>

<span class="sd">&quot;&quot;&quot;Client Library for Keystone Resources.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">keystoneclient.v2_0</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">kc</span>
<span class="kn">from</span> <span class="nn">oslo.config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">oslo.utils</span> <span class="kn">import</span> <span class="n">importutils</span>

<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LE</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LI</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LW</span>
<span class="kn">from</span> <span class="nn">heat.openstack.common</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;heat.common.keystoneclient&#39;</span><span class="p">)</span>
<span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Keystone V2 loaded&quot;</span><span class="p">))</span>


<div class="viewcode-block" id="KeystoneClientV2"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2">[docs]</a><span class="k">class</span> <span class="nc">KeystoneClientV2</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Wrap keystone client so we can encapsulate logic used in resources.</span>

<span class="sd">    Note this is intended to be initialized from a resource on a per-session</span>
<span class="sd">    basis, so the session context is passed in on initialization</span>
<span class="sd">    Also note that a copy of this is created every resource as self.keystone()</span>
<span class="sd">    via the code in engine/client.py, so there should not be any need to</span>
<span class="sd">    directly instantiate instances of this class inside resources themselves.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c"># If a trust_id is specified in the context, we immediately</span>
        <span class="c"># authenticate so we can populate the context with a trust token</span>
        <span class="c"># otherwise, we delay client authentication until needed to avoid</span>
        <span class="c"># unnecessary calls to keystone.</span>
        <span class="c">#</span>
        <span class="c"># Note that when you obtain a token using a trust, it cannot be</span>
        <span class="c"># used to reauthenticate and get another token, so we have to</span>
        <span class="c"># get a new trust-token even if context.auth_token is set.</span>
        <span class="c">#</span>
        <span class="c"># - context.auth_url is expected to contain the v2.0 keystone endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">trust_id</span><span class="p">:</span>
            <span class="c"># Create a connection to the v2 API, with the trust_id, this</span>
            <span class="c"># populates self.context.auth_token with a trust-scoped token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v2_client_init</span><span class="p">()</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="KeystoneClientV2.client"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.client">[docs]</a>    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v2_client_init</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span>
</div>
    <span class="k">def</span> <span class="nf">_v2_client_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;auth_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">auth_url</span><span class="p">,</span>
            <span class="s">&#39;region_name&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">region_name_for_services</span>
        <span class="p">}</span>
        <span class="n">auth_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Note try trust_id first, as we can&#39;t reuse auth_token in that case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">trust_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># We got a trust_id, so we use the admin credentials</span>
            <span class="c"># to authenticate, then re-scope the token to the</span>
            <span class="c"># trust impersonating the trustor user.</span>
            <span class="c"># Note that this currently requires the trustor tenant_id</span>
            <span class="c"># to be passed to the authenticate(), unlike the v3 call</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_service_admin_creds</span><span class="p">())</span>
            <span class="n">auth_kwargs</span><span class="p">[</span><span class="s">&#39;trust_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">trust_id</span>
            <span class="n">auth_kwargs</span><span class="p">[</span><span class="s">&#39;tenant_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant_id</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">auth_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;tenant_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">auth_token</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">username</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">password</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;tenant_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;tenant_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;Keystone v2 API connection failed, no password &quot;</span>
                          <span class="s">&quot;or auth_token!&quot;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">AuthorizationFailure</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cacert&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client_option</span><span class="p">(</span><span class="s">&#39;ca_file&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;insecure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client_option</span><span class="p">(</span><span class="s">&#39;insecure&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cert&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client_option</span><span class="p">(</span><span class="s">&#39;cert_file&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client_option</span><span class="p">(</span><span class="s">&#39;key_file&#39;</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">kc</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">client</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="o">**</span><span class="n">auth_kwargs</span><span class="p">)</span>
        <span class="c"># If we are authenticating with a trust auth_kwargs are set, so set</span>
        <span class="c"># the context auth_token with the re-scoped trust token</span>
        <span class="k">if</span> <span class="n">auth_kwargs</span><span class="p">:</span>
            <span class="c"># Sanity check</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">auth_ref</span><span class="o">.</span><span class="n">trust_scoped</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;v2 trust token re-scoping failed!&quot;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">AuthorizationFailure</span><span class="p">()</span>
            <span class="c"># All OK so update the context with the token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">auth_token</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">auth_ref</span><span class="o">.</span><span class="n">auth_token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">auth_url</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;auth_url&#39;</span><span class="p">)</span>
            <span class="c"># Ensure the v2 API we&#39;re using is not impacted by keystone</span>
            <span class="c"># bug #1239303, otherwise we can&#39;t trust the user_id</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">trustor_user_id</span> <span class="o">!=</span> <span class="n">client</span><span class="o">.</span><span class="n">auth_ref</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;Trust impersonation failed, bug #1239303 &quot;</span>
                              <span class="s">&quot;suspected, you may need a newer keystone&quot;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">AuthorizationFailure</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">client</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_service_admin_creds</span><span class="p">():</span>
        <span class="c"># Import auth_token to have keystone_authtoken settings setup.</span>
        <span class="n">importutils</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s">&#39;keystonemiddleware.auth_token&#39;</span><span class="p">)</span>

        <span class="n">creds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">keystone_authtoken</span><span class="o">.</span><span class="n">admin_user</span><span class="p">,</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">keystone_authtoken</span><span class="o">.</span><span class="n">admin_password</span><span class="p">,</span>
            <span class="s">&#39;auth_url&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">keystone_authtoken</span><span class="o">.</span><span class="n">auth_uri</span><span class="p">,</span>
            <span class="s">&#39;tenant_name&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">keystone_authtoken</span><span class="o">.</span><span class="n">admin_tenant_name</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">creds</span>

    <span class="k">def</span> <span class="nf">_get_client_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="c"># look for the option in the [clients_keystone] section</span>
        <span class="c"># unknown options raise cfg.NoSuchOptError</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">,</span>
                            <span class="n">group</span><span class="o">=</span><span class="s">&#39;clients_keystone&#39;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">clients_keystone</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="c"># look for the option in the generic [clients] section</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s">&#39;clients&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">clients</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>

<div class="viewcode-block" id="KeystoneClientV2.create_stack_user"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.create_stack_user">[docs]</a>    <span class="k">def</span> <span class="nf">create_stack_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a user defined as part of a stack, either via template</span>
<span class="sd">        or created internally by a resource.  This user will be added to</span>
<span class="sd">        the heat_stack_user_role as defined in the config</span>
<span class="sd">        Returns the keystone ID of the resulting user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s">&quot;Truncating the username </span><span class="si">%s</span><span class="s"> to the last 64 &quot;</span>
                         <span class="s">&quot;characters.&quot;</span><span class="p">),</span> <span class="n">username</span><span class="p">)</span>
            <span class="c">#get the last 64 characters of the username</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">[</span><span class="o">-</span><span class="mi">64</span><span class="p">:]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="p">,</span>
                                        <span class="n">password</span><span class="p">,</span>
                                        <span class="s">&#39;</span><span class="si">%s</span><span class="s">@openstack.org&#39;</span> <span class="o">%</span> <span class="n">username</span><span class="p">,</span>
                                        <span class="n">tenant_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
                                        <span class="n">enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># We add the new user to a special keystone role</span>
        <span class="c"># This role is designed to allow easier differentiation of the</span>
        <span class="c"># heat-generated &quot;stack users&quot; which will generally have credentials</span>
        <span class="c"># deployed on an instance (hence are implicitly untrusted)</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">stack_user_role</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roles</span>
                           <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">heat_stack_user_role</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack_user_role</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">role_id</span> <span class="o">=</span> <span class="n">stack_user_role</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Adding user </span><span class="si">%(user)s</span><span class="s"> to role </span><span class="si">%(role)s</span><span class="s">&quot;</span>
                      <span class="o">%</span> <span class="p">{</span><span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&#39;role&#39;</span><span class="p">:</span> <span class="n">role_id</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">add_user_role</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">role_id</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;Failed to add user </span><span class="si">%(user)s</span><span class="s"> to role </span><span class="si">%(role)s</span><span class="s">, &quot;</span>
                          <span class="s">&quot;check role exists!&quot;</span><span class="p">),</span>
                      <span class="p">{</span><span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
                       <span class="s">&#39;role&#39;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">heat_stack_user_role</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.delete_stack_user"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.delete_stack_user">[docs]</a>    <span class="k">def</span> <span class="nf">delete_stack_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.delete_ec2_keypair"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.delete_ec2_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">delete_ec2_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">accesskey</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">accesskey</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.get_ec2_keypair"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.get_ec2_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">get_ec2_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">auth_ref</span><span class="o">.</span><span class="n">user_id</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">access</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.create_ec2_keypair"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.create_ec2_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">create_ec2_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">user_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">auth_ref</span><span class="o">.</span><span class="n">user_id</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.disable_stack_user"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.disable_stack_user">[docs]</a>    <span class="k">def</span> <span class="nf">disable_stack_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">update_enabled</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.enable_stack_user"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.enable_stack_user">[docs]</a>    <span class="k">def</span> <span class="nf">enable_stack_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">update_enabled</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.url_for"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.url_for">[docs]</a>    <span class="k">def</span> <span class="nf">url_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">service_catalog</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="KeystoneClientV2.auth_token"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.auth_token">[docs]</a>    <span class="k">def</span> <span class="nf">auth_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">auth_token</span>

    <span class="c"># ##################### #</span>
    <span class="c"># V3 Compatible Methods #</span>
    <span class="c"># ##################### #</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.create_stack_domain_user"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.create_stack_domain_user">[docs]</a>    <span class="k">def</span> <span class="nf">create_stack_domain_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_stack_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.delete_stack_domain_user"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.delete_stack_domain_user">[docs]</a>    <span class="k">def</span> <span class="nf">delete_stack_domain_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_stack_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.create_stack_domain_project"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.create_stack_domain_project">[docs]</a>    <span class="k">def</span> <span class="nf">create_stack_domain_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use the tenant ID as domain project.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant_id</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.delete_stack_domain_project"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.delete_stack_domain_project">[docs]</a>    <span class="k">def</span> <span class="nf">delete_stack_domain_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Pass through method since no project was created.&#39;&#39;&#39;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.create_stack_domain_user_keypair"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.create_stack_domain_user_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">create_stack_domain_user_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_ec2_keypair</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.delete_stack_domain_user_keypair"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.delete_stack_domain_user_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">delete_stack_domain_user_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span>
                                         <span class="n">credential_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_ec2_keypair</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">credential_id</span><span class="p">)</span>

    <span class="c"># ###################### #</span>
    <span class="c"># V3 Unsupported Methods #</span>
    <span class="c"># ###################### #</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.create_trust_context"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.create_trust_context">[docs]</a>    <span class="k">def</span> <span class="nf">create_trust_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Returning fake trust context.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
</div>
<div class="viewcode-block" id="KeystoneClientV2.delete_trust"><a class="viewcode-back" href="../../sourcecode/contrib/heat_keystoneclient_v2/heat_keystoneclient_v2.client.html#heat_keystoneclient_v2.client.KeystoneClientV2.delete_trust">[docs]</a>    <span class="k">def</span> <span class="nf">delete_trust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trust_id</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Fake deleting trust.&quot;</span><span class="p">)</span>
        <span class="k">return</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">heat 2015.1.dev542.ga481ba9 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012,2013 Heat Developers.
      Last updated on Mon Dec 8 11:11:34 2014, commit a481ba9.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>